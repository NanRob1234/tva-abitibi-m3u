name: Mise à jour TVA Abitibi (72h) - 30 min

on:
  schedule:
    - cron: "*/30 * * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - run: pip install google-api-python-client

      - name: Générer site + m3u
        env:
          YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
        run: |
          python - <<'PY'
          import os
          from datetime import datetime, timedelta, timezone
          from zoneinfo import ZoneInfo
          from googleapiclient.discovery import build

          API_KEY = os.environ["YOUTUBE_API_KEY"]
          OFFICIAL_CHANNEL_ID = "UC0P74lX2SeJsRAJ3iCgxJIA"

          youtube = build("youtube", "v3", developerKey=API_KEY)

          now = datetime.now(ZoneInfo("America/Toronto"))
          since = now - timedelta(hours=72)

          def iso(dt):
              return dt.astimezone(timezone.utc).replace(microsecond=0).isoformat().replace("+00:00","Z")

          SECTIONS = [
              ("TVA Abitibi - Midi", "TVA Abitibi Midi"),
              ("TVA Abitibi - 18h", "TVA Abitibi 18h"),
              ("TVA Nouvelles week-end", "TVA Nouvelles week-end"),
          ]

          def search_videos(query):
              req = youtube.search().list(
                  part="snippet",
                  q=query,
                  channelId=OFFICIAL_CHANNEL_ID,
                  type="video",
                  order="date",
                  publishedAfter=iso(since),
                  maxResults=10,
              )
              res = req.execute()
              out = []
              for it in res.get("items", []):
                  vid = it["id"].get("videoId")
                  if not vid:
                      continue
                  sn = it["snippet"]
                  out.append({
                      "videoId": vid,
                      "title": sn.get("title",""),
                      "publishedAt": sn.get("publishedAt",""),
                      "url": f"https://www.youtube.com/watch?v={vid}",
                  })
              return out

          def parse_dt(s):
              return datetime.fromisoformat(s.replace("Z","+00:00"))

          videos = []
          seen = set()

          for label, q in SECTIONS:
              for v in search_videos(q):
                  if v["videoId"] in seen:
                      continue
                  seen.add(v["videoId"])
                  v["section"] = label
                  videos.append(v)

          videos.sort(key=lambda x: parse_dt(x["publishedAt"]), reverse=True)

          # Générer M3U
          m3u = ["#EXTM3U"]
          for v in videos:
              local_time = parse_dt(v["publishedAt"]).astimezone(ZoneInfo("America/Toronto"))
              dt = local_time.strftime("%Y-%m-%d %H:%M")
              m3u.append(f'#EXTINF:-1 group-title="TVA Abitibi",{v["section"]} — {dt} — {v["title"]}')
              m3u.append(v["url"])
              m3u.append("")

          open("tva.m3u","w",encoding="utf-8").write("\n".join(m3u))

          # Générer HTML
          cards = ""
          for v in videos:
              local_time = parse_dt(v["publishedAt"]).astimezone(ZoneInfo("America/Toronto"))
              dt = local_time.strftime("%Y-%m-%d %H:%M")
              cards += f"""
              <div style="background:#111;padding:15px;margin:10px;border-radius:10px;">
                <div><b>{v['section']}</b> — {dt}</div>
                <div>{v['title']}</div>
                <a href="{v['url']}" target="_blank">Ouvrir sur YouTube</a>
              </div>
              """

          html = f"""
          <html>
          <body style="background:#000;color:#fff;font-family:Arial;">
          <h1>TVA Abitibi - Dernières 72h (Heure Québec)</h1>
          {cards if cards else "<p>Aucune vidéo trouvée</p>"}
          </body>
          </html>
          """

          open("index.html","w",encoding="utf-8").write(html)
          PY

      - name: Commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add index.html tva.m3u
          git diff --cached --quiet || git commit -m "Update Québec time"
          git push
