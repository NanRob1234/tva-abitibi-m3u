name: Mise à jour TVA Abitibi

on:
  schedule:
    - cron: "0 12 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Installer Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Installer dépendances
        run: |
          python -m pip install --upgrade pip
          pip install google-api-python-client

      - name: Générer le fichier M3U
        env:
          YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
        run: |
          python3 - <<'PY'
          from googleapiclient.discovery import build
          import os

          API_KEY = os.environ["YOUTUBE_API_KEY"]
          youtube = build("youtube", "v3", developerKey=API_KEY)

          def chercher_video(recherche):
              req = youtube.search().list(
                  part="snippet",
                  q=recherche,
                  type="video",
                  order="date",
                  maxResults=1
              )
              res = req.execute()
              items = res.get("items", [])
              if items:
                  return "https://www.youtube.com/watch?v=" + items[0]["id"]["videoId"]
              return "VIDÉO_NON_TROUVÉE"

          lien_midi = chercher_video("Abitibi Midi")
          lien_18h = chercher_video("Abitibi 18h")

          contenu = f"""#EXTM3U

          #EXTINF:-1 group-title="TVA Abitibi",TVA Abitibi - Midi
          {lien_midi}

          #EXTINF:-1 group-title="TVA Abitibi",TVA Abitibi - 18h
          {lien_18h}
          """

          with open("tva.m3u", "w", encoding="utf-8") as f:
              f.write(contenu)
          PY

      - name: Commit et push (seulement si changement)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add tva.m3u
          git diff --cached --quiet || git commit -m "Mise à jour automatique"
          git push
