name: Mise à jour TVA Abitibi (72h)

on:
  schedule:
    - cron: "0 * * * *"   # chaque heure (tu peux changer)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Installer Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Installer dépendances
        run: |
          python -m pip install --upgrade pip
          pip install google-api-python-client

      - name: Générer page TVA (72h)
        env:
          YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
        run: |
          python3 - <<'PY'
          from googleapiclient.discovery import build
          import os
          from datetime import datetime, timezone, timedelta
          import html

          API_KEY = os.environ["YOUTUBE_API_KEY"]
          youtube = build("youtube", "v3", developerKey=API_KEY)

          CHANNEL_ID = "UCOP74lX2SeJsRAJ3iCgxJlA"  # TVA Abitibi-Témiscamingue (officiel)

          cutoff = datetime.now(timezone.utc) - timedelta(hours=72)

          queries = [
              ("Bulletin TVA MIDI", "TVA Abitibi - Midi"),
              ("Bulletin TVA 18h", "TVA Abitibi - 18h"),
              ("Revue de la semaine", "TVA Nouvelles week-end"),
              ("week-end", "TVA Nouvelles week-end (alt)"),
          ]

          def iso_to_dt(iso):
              return datetime.fromisoformat(iso.replace("Z", "+00:00")).astimezone(timezone.utc)

          def search_recent(query, max_results=10):
              res = youtube.search().list(
                  part="snippet",
                  q=query,
                  channelId=CHANNEL_ID,
                  type="video",
                  order="date",
                  maxResults=max_results
              ).execute()

              out = []
              for it in res.get("items", []):
                  sn = it["snippet"]
                  published = iso_to_dt(sn["publishedAt"])
                  if published < cutoff:
                      continue
                  out.append({
                      "title": sn["title"],
                      "published": published,
                      "url": f'https://www.youtube.com/watch?v={it["id"]["videoId"]}',
                      "query": query
                  })
              return out

          # Collecte (dédupe par URL)
          videos = []
          seen = set()
          for q, label in queries:
              for v in search_recent(q, max_results=12):
                  if v["url"] in seen:
                      continue
                  seen.add(v["url"])
                  v["label"] = label
                  videos.append(v)

          # Tri par date décroissante
          videos.sort(key=lambda x: x["published"], reverse=True)

          # HTML simple
          def fmt_dt(dt):
              return dt.strftime("%Y-%m-%d %H:%M UTC")

          rows = []
          for v in videos:
              title = html.escape(v["title"])
              label = html.escape(v["label"])
              date = fmt_dt(v["published"])
              url = html.escape(v["url"])
              rows.append(f"""
                <div class="card">
                  <div class="meta">{label} — {date}</div>
                  <div class="title">{title}</div>
                  <a class="btn" href="{url}" target="_blank" rel="noopener">Ouvrir sur YouTube</a>
                </div>
              """)

          page = f"""<!doctype html>
          <html lang="fr">
          <head>
            <meta charset="utf-8" />
            <meta name="viewport" content="width=device-width, initial-scale=1" />
            <title>TVA Abitibi — Dernières 72h</title>
            <style>
              body {{ font-family: Arial, sans-serif; margin: 20px; background:#111; color:#eee; }}
              h1 {{ margin: 0 0 6px; }}
              .sub {{ opacity: .8; margin-bottom: 16px; }}
              .card {{ background:#1c1c1c; border:1px solid #333; border-radius:12px; padding:14px; margin:12px 0; }}
              .meta {{ font-size: 14px; opacity:.8; margin-bottom:8px; }}
              .title {{ font-size: 18px; margin-bottom:10px; line-height:1.2; }}
              .btn {{ display:inline-block; padding:10px 12px; border-radius:10px; background:#2b6cff; color:white; text-decoration:none; }}
              .btn:visited {{ color:white; }}
            </style>
          </head>
          <body>
            <h1>TVA Abitibi — Dernières 72 heures</h1>
            <div class="sub">Chaîne officielle seulement (UCOP74lX2SeJsRAJ3iCgxJlA). Mis à jour automatiquement.</div>
            {''.join(rows) if rows else "<p>Aucune vidéo trouvée dans les dernières 72 heures.</p>"}
          </body>
          </html>
          """

          with open("index.html", "w", encoding="utf-8") as f:
              f.write(page)
          PY

      - name: Commit et push (si changement)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add index.html
          git diff --cached --quiet || git commit -m "MAJ page TVA (72h)"
          git push
