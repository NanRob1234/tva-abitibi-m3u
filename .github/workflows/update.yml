name: Mise à jour automatique TVA Abitibi

on:
  schedule:
    - cron: "0 16 * * *"   # 11h Québec (16h UTC)
  workflow_dispatch:

jobs:
  update-m3u:
    runs-on: ubuntu-latest

    steps:
      - name: Cloner le dépôt
        uses: actions/checkout@v3

      - name: Installer Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Installer dépendances
        run: pip install requests google-api-python-client

      - name: Mettre à jour le fichier M3U
        run: |
          python3 << 'EOF'
          from googleapiclient.discovery import build
          import os

          API_KEY = os.getenv("YOUTUBE_API_KEY")

          youtube = build("youtube", "v3", developerKey=API_KEY)

          def chercher_video(recherche):
              req = youtube.search().list(
                  q=recherche,
                  part="snippet",
                  type="video",
                  maxResults=1,
                  order="date"
              )
              res = req.execute()
              if res["items"]:
                  return "https://www.youtube.com/watch?v=" + res["items"][0]["id"]["videoId"]
              return "VIDÉO_NON_TROUVÉE"

          lien_midi = chercher_video("Abitibi Midi")
          lien_18h = chercher_video("Abitibi 18h")

          contenu = f"""#EXTM3U

#EXTINF:-1 group-title="TVA Abitibi",TVA Abitibi - Midi
{lien_midi}

#EXTINF:-1 group-title="TVA Abitibi",TVA Abitibi - 18h
{lien_18h}
"""

          with open("tva.m3u", "w") as f:
              f.write(contenu)
          EOF

      - name: Commit et push
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git add tva.m3u
          git commit -m "Mise à jour automatique du fichier M3U" || echo "Aucun changement"
          git push
